<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>RovenSports ‚Ä¢ Giri≈ü</title>
<style>
  :root{
    --bg1:#0b1220;
    --bg2:#0b2a2a;
    --card:rgba(255,255,255,.06);
    --border:rgba(255,255,255,.10);
    --text:rgba(255,255,255,.92);
    --muted:rgba(255,255,255,.65);
    --accent:#00c6ff;
    --danger:#ff4d4d;
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh;
    display:grid; place-items:center;
    color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background:
      radial-gradient(1200px 700px at 20% 20%, rgba(0,198,255,.18), transparent 60%),
      radial-gradient(900px 600px at 80% 30%, rgba(0,255,196,.12), transparent 60%),
      linear-gradient(135deg, var(--bg1), var(--bg2));
    overflow:hidden;
  }
  .wrap{
    width:min(460px, 92vw);
  }
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:18px;
    padding:28px;
    backdrop-filter: blur(12px);
    box-shadow: 0 20px 60px rgba(0,0,0,.35);
  }
  .brand{
    display:flex; align-items:center; gap:12px;
    margin-bottom:14px;
  }
  .logo{
    width:44px; height:44px; border-radius:12px;
    display:grid; place-items:center;
    background: linear-gradient(135deg, rgba(0,198,255,.35), rgba(0,255,196,.22));
    border:1px solid var(--border);
    font-size:22px;
  }
  h1{font-size:20px; margin:0}
  .sub{margin:6px 0 18px; color:var(--muted); font-size:13px; line-height:1.4}
  .field{
    display:flex; flex-direction:column; gap:8px; margin-top:12px;
  }
  label{font-size:12px; color:var(--muted)}
  input{
    padding:14px 14px;
    border-radius:12px;
    border:1px solid var(--border);
    outline:none;
    background:rgba(0,0,0,.25);
    color:var(--text);
    font-size:14px;
    letter-spacing:.4px;
  }
  input:focus{border-color: rgba(0,198,255,.55); box-shadow:0 0 0 4px rgba(0,198,255,.12)}
  .row{display:flex; gap:10px; align-items:center; margin-top:14px}
  button{
    width:100%;
    padding:14px 16px;
    border:none;
    border-radius:12px;
    background: linear-gradient(135deg, var(--accent), #00ffd0);
    color:#001018;
    font-weight:800;
    cursor:pointer;
    transition: transform .08s ease;
  }
  button:active{transform: scale(.99)}
  button[disabled]{opacity:.6; cursor:not-allowed}
  .msg{margin-top:14px; font-size:13px; color:var(--danger); min-height:18px}
  .ok{color:#6dff9c}
  .footer{
    margin-top:12px; text-align:center; color:var(--muted); font-size:12px;
  }
  .pill{
    display:inline-flex; gap:8px; align-items:center;
    padding:8px 10px; border-radius:999px;
    border:1px solid var(--border);
    background:rgba(0,0,0,.18);
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="brand">
        <div class="logo">üîê</div>
        <div>
          <h1>RovenSports</h1>
          <div class="sub">Lisans anahtarƒ±n ile giri≈ü yap. Key ilk giri≈ü yapƒ±lan cihaza kilitlenir.</div>
        </div>
      </div>

      <div class="pill" id="devicePill">Cihaz ID hazƒ±rlanƒ±yor‚Ä¶</div>

      <div class="field">
        <label for="keyInput">Lisans Key</label>
        <input id="keyInput" autocomplete="off" placeholder="√ñrn: VS7M32GDUJSG7EG4CQQ" />
      </div>

      <div class="row">
        <button id="loginBtn" onclick="login()">Giri≈ü Yap</button>
      </div>

      <div class="msg" id="msg"></div>
      <div class="footer">¬© RovenSports</div>
    </div>
  </div>

<script>
const API_URL = "https://roven-api.rovensports.workers.dev";

function getDeviceId(){
  let id = localStorage.getItem("device_id");
  if(!id){
    // UUID yoksa random √ºret
    if (crypto?.randomUUID) id = crypto.randomUUID();
    else id = "dev_" + Math.random().toString(16).slice(2) + Date.now();
    localStorage.setItem("device_id", id);
  }
  return id;
}

function secondsToText(sec){
  if (sec == null) return "Sƒ±nƒ±rsƒ±z";
  const s = Math.max(0, sec);
  const d = Math.floor(s / 86400);
  const h = Math.floor((s % 86400) / 3600);
  const m = Math.floor((s % 3600) / 60);
  if (d > 0) return `${d}g ${h}s`;
  if (h > 0) return `${h}s ${m}dk`;
  return `${m}dk`;
}

// Token varsa dashboard'a at
(function autoForward(){
  const token = localStorage.getItem("token");
  if (!token) return;
  window.location.href = "dashboard.html";
})();

const deviceId = getDeviceId();
document.getElementById("devicePill").textContent = "Cihaz Kilidi: aktif ‚úÖ";

async function login(){
  const btn = document.getElementById("loginBtn");
  const msg = document.getElementById("msg");
  const key = document.getElementById("keyInput").value.trim();

  msg.textContent = "";
  if(!key){
    msg.textContent = "Key bo≈ü olamaz.";
    return;
  }

  btn.disabled = true;
  btn.textContent = "Giri≈ü yapƒ±lƒ±yor‚Ä¶";

  try{
    const res = await fetch(API_URL + "/api/login", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ key, deviceId })
    });

    const data = await res.json().catch(()=>null);

    if(!data || !data.ok){
      const err = data?.error || "UNKNOWN";
      if (err === "KEY_ALREADY_USED_ON_ANOTHER_DEVICE"){
        msg.textContent = "Bu key ba≈üka bir cihazda kullanƒ±lƒ±yor. (1 key = 1 ki≈üi)";
      } else if (err === "EXPIRED"){
        msg.textContent = "Key s√ºresi dolmu≈ü.";
      } else if (err === "INVALID_KEY"){
        msg.textContent = "Ge√ßersiz key.";
      } else {
        msg.textContent = "Giri≈ü ba≈üarƒ±sƒ±z: " + err;
      }
      return;
    }

    localStorage.setItem("token", data.token);
    // exp data.exp olabilir
    const left = (data.exp == null) ? null : (data.exp - Math.floor(Date.now()/1000));
    msg.classList.add("ok");
    msg.textContent = "Giri≈ü ba≈üarƒ±lƒ± ‚úÖ (Kalan: " + secondsToText(left) + ")";
    setTimeout(()=> location.href = "dashboard.html", 350);

  }catch(e){
    msg.textContent = "Baƒülantƒ± hatasƒ±. Tekrar dene.";
  }finally{
    btn.disabled = false;
    btn.textContent = "Giri≈ü Yap";
  }
}
</script>
</body>
</html>
